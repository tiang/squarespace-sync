include:
  - docker-compose.infra.yml

services:
  api:
    build:
      context: ./api
      target: dev
    ports:
      - "3001:3001"
    volumes:
      - ./api:/app
      - api_node_modules:/app/node_modules
    environment:
      NODE_ENV: development
      DATABASE_URL: postgres://postgres:${POSTGRES_PASSWORD:-localdev}@postgres:5432/${POSTGRES_DB:-platform}
      FIRESTORE_EMULATOR_HOST: firebase:8080
      FIREBASE_AUTH_EMULATOR_HOST: firebase:9099
      GCS_API_ENDPOINT: http://gcs:4443
      # 5173=admin, 5174=parent-portal (Docker), 5175=parent-portal fallback (local dev when 5174 is taken)
      CORS_ORIGIN: http://localhost:5173,http://localhost:5174,http://localhost:5175
    depends_on:
      postgres:
        condition: service_healthy
      firebase:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  admin:
    build:
      context: ./admin
      target: dev
    ports:
      - "5173:5173"
    volumes:
      - ./admin:/app
      - admin_node_modules:/app/node_modules
      - ./ui:/ui
    environment:
      VITE_API_URL: http://localhost:3001
    depends_on:
      api:
        condition: service_healthy

  parent-portal:
    build:
      context: ./parent-portal
      target: dev
    ports:
      - "5174:5174"
    volumes:
      - ./parent-portal:/app
      - parent_portal_node_modules:/app/node_modules
      - ./ui:/ui
    environment:
      VITE_API_URL: http://localhost:3001
    depends_on:
      api:
        condition: service_healthy

volumes:
  api_node_modules:
  admin_node_modules:
  parent_portal_node_modules:
